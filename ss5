#!/bin/bash
set -e

PORT=1080
USER="proxyuser"
PASS="proxypass"
CONF_PATH="/etc/opt/ss5/ss5.conf"
AUTH_PATH="/etc/opt/ss5/ss5.passwd"

echo "ðŸ“¦ å®‰è£… SS5ï¼ˆæ”¯æŒ SOCKS5 å’Œ HTTPï¼‰..."
apt update
apt install -y gcc make libpam0g-dev libssl-dev iproute2 wget curl sudo

# èŽ·å–æºç å¹¶ç¼–è¯‘å®‰è£… SS5
cd /tmp
wget https://github.com/MerlinKodo/ss5/archive/refs/heads/master.zip -O ss5.zip
unzip ss5.zip
cd ss5-master
./configure
make && make install

# æ·»åŠ è®¤è¯é…ç½®
echo "auth 0.0.0.0/0 - u" >> $CONF_PATH
echo "permit u $USER" >> $CONF_PATH
echo "$USER $PASS" > $AUTH_PATH
chmod 600 $AUTH_PATH

# å¼€å¯è®¤è¯åŠŸèƒ½
sed -i 's/^auth.*$/auth    0.0.0.0\/0    -    u/' $CONF_PATH
sed -i 's/^permit.*$/permit u    '$USER'/' $CONF_PATH

# åˆ›å»ºæœåŠ¡æ–‡ä»¶
cat > /etc/systemd/system/ss5.service <<EOF
[Unit]
Description=SS5 Socks Server
After=network.target

[Service]
ExecStart=/usr/local/sbin/ss5 -u root
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
systemctl daemon-reexec
systemctl daemon-reload
systemctl enable ss5
systemctl restart ss5

# èŽ·å–å…¬ç½‘ IP
IP=$(curl -s ifconfig.me)

echo "âœ… SS5 å®‰è£…å®Œæˆ"
echo "----------------------------------"
echo "åœ°å€: $IP"
echo "ç«¯å£: $PORT"
echo "è´¦å·: $USER"
echo "å¯†ç : $PASS"
echo "åè®®: SOCKS5 / HTTP"
echo "----------------------------------"
