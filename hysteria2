#!/bin/bash

# 安装 curl 和 unzip（如果没有）
apt update && apt install -y curl unzip

# 下载最新版 Hysteria2
VERSION=$(curl -s https://api.github.com/repos/apernet/hysteria/releases/latest | grep tag_name | cut -d '"' -f 4)
wget -O hysteria.tar.gz https://github.com/apernet/hysteria/releases/download/${VERSION}/hysteria-linux-amd64.tar.gz
tar -xzvf hysteria.tar.gz
mv hysteria /usr/local/bin/
chmod +x /usr/local/bin/hysteria

# 随机生成密码
PASS=$(openssl rand -hex 8)

# 生成自签 TLS 证书
mkdir -p /etc/hysteria
openssl ecparam -genkey -name prime256v1 -out /etc/hysteria/private.key
openssl req -new -x509 -key /etc/hysteria/private.key -out /etc/hysteria/cert.pem -days 3650 -subj "/CN=bing.com"

# 写入配置文件
cat > /etc/hysteria/config.yaml <<EOF
listen: :5678
tls:
  cert: /etc/hysteria/cert.pem
  key: /etc/hysteria/private.key
auth:
  type: password
  password: $PASS
masquerade:
  type: proxy
  proxy:
    url: https://www.bing.com
    rewriteHost: true
EOF

# 创建 systemd 服务
cat > /etc/systemd/system/hysteria.service <<EOF
[Unit]
Description=Hysteria 2 Server
After=network.target

[Service]
ExecStart=/usr/local/bin/hysteria server --config /etc/hysteria/config.yaml
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
systemctl daemon-reexec
systemctl enable hysteria
systemctl start hysteria

# 获取服务器 IP
IP=$(curl -s ipv4.ip.sb)

# 输出连接信息
echo
echo "✅ 部署完成！以下是你的 Hysteria2 节点信息："
echo
echo "hy2://$PASS@$IP:5678?insecure=1&sni=bing.com#Hysteria2-无域名节点"
